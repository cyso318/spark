[![Audit backend](https://github.com/Maloschnikow/SPARK-stack/actions/workflows/audit.yml/badge.svg)](https://github.com/Maloschnikow/SPARK-stack/actions/workflows/audit.yml)
[![CI](https://github.com/Maloschnikow/SPARK-stack/actions/workflows/ci.yml/badge.svg)](https://github.com/Maloschnikow/SPARK-stack/actions/workflows/ci.yml)

## Development
Might wanna use the [Nix](https://nixos.org/download/) packet manager with this one.

You can also additionally use [nix-direnv](https://github.com/nix-community/nix-direnv).
In that case you probably also want the [mkhl.direnv](https://github.com/direnv/direnv-vscode) extension for vscode.

In case you don't wanna make the additional effort and only use Nix, you can simply run
`nix develop` to end up in a development shell with the right environment.\
Oh and if you're using vscode, you might also wanna use the recommended extensions.

### Backend
Is contained in the `backend` directory. (`cd backend/`)

Audit packages with `cargo-audit audit` and `cargo-audit audit fix`.\
Run with `cargo run`.\
Find API documentation under `localhost:3000/doc`.

### Database
The password is `password`.

The Nix environment provides some commands to control the database:
> `db-start` - start / initialize database 
>
> `db-stop` - stop database
>
> `db-reset` - reset and restart database
>
> `db-upgrade` - migrate database upwards (apply every migration)
>
> `db-downgrade` - migrate database downwards (one migration at a time)

#### Migrations
[sqlx-cli](https://github.com/launchbadge/sqlx/tree/main/sqlx-cli) is used for migrations.
The `db-upgrade` and `db-downgrade` commands use it under the hood as well.

> `sqlx migrate add --source database/migrations` - add a migration
>
> `sqlx migrate --help` - get help on how to use this command

> [!IMPORTANT]
> After changing the database version by migrating, you need to run
> `clorinde live -q database/queries` to generate new [Rust types](#rust-types).
> (The database needs to run for this)

#### Rust types
[clorinde](https://github.com/halcyonnouveau/clorinde) is used to generate Rust types
from the running database.
If you want to access the database from your code, you need to write the SQL statements
into the `database/queries` directory. clorinde has a special syntax, read about it [here](https://halcyonnouveau.github.io/clorinde/).

You need to [generate new rust types after migrating](#migrations) the database.

> [!TIP]
> Use `database/dev_init.sql` to fill the database with example data.

### Workflows (CI/CD)
The Nix environment includes [act](https://github.com/nektos/act) to
run GitHub Actions locally. This enables us to test workflows locally
and check if they work before committing them.
act requires docker to run.

> `acts` = `act --rm --action-cache-path $REPO_ROOT/.cache/act --cache-server-path $REPO_ROOT/.cache/actcache`

Instead of running `act` you should run `acts` to safe the cache in your local repository and remove docker containers after a workflow failure. It's a shell script provided by the Nix environment.
After running `acts` you can find the caches within `.cache`.

When you run `acts` for the first time, you get asked on what image you want to use.
I recommend using the `full` sized image, they are quite large, but are essentially
equal to GitHub runners. More about the runners can be found [here](https://nektosact.com/usage/runners.html).
A usage guide can be found [here](https://nektosact.com/usage/index.html).

> [!IMPORTANT]
> If you need to run `acts` with `sudo`, make sure to preserve the user environment with `sudo -E acts`.

### Folder structure
Here's a quick overview over what you can find where in this repository.
```sh
./
├── backend # Contains Rust code
│   ├── clorinde # Crate generated by clorinde
│   └── src # Contains API code
├── database
│   ├── migrations # SQL migrations to use with sqlx-cli
│   └── queries # SQL queries, which are used by clorinde
└── nix # Stuff to include in flake.nix
```